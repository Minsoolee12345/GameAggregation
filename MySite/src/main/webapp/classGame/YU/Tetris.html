<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Game</title>
<style>
    body {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: Arial, sans-serif;
    }
    #game-container {
        display: flex;
    }
    #game-board {
        display: grid;
        grid-template-columns: repeat(10, 30px);
        grid-template-rows: repeat(20, 30px);
        gap: 1px;
        background-color: #333;
    }
    .cell {
        width: 30px;
        height: 30px;
        background-color: #444;
    }
    #next-block-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-left: 20px;
    }
    #next-block {
        display: grid;
        grid-template-columns: repeat(5, 30px);
        grid-template-rows: repeat(5, 30px);
        gap: 1px;
        background-color: #222;
    }
    .next-cell {
        width: 30px;
        height: 30px;
        background-color: #444;
    }
    #score {
        margin-top: 10px;
        font-size: 18px;
    }
    #start-button, #restart-button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
    }
</style>
</head>
<body>
    <h1>Tetris Game</h1>
    <div id="score">Score: 0</div>
    <div id="game-container">
        <div id="game-board"></div>
        <div id="next-block-container">
            <h3>Next Block</h3>
            <div id="next-block"></div>
        </div>
    </div>
    <button id="start-button">게임 시작</button>
    <button id="restart-button" style="display: none;">다시 하기</button>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
	// 세로 20칸
    const rows = 20; 
    // 가로 10칸
	const cols = 10;
    // 테트리스 판 초기화
    const board = Array.from(Array(rows), () => Array(cols).fill(0)); 
    let currentBlock, nextBlock, score = 0, timer;

    // 게임판과 셀 생성
    for (let i = 0; i < rows * cols; i++) {
        $('#game-board').append('<div class="cell"></div>');
    }

    // 다음 블록을 표시할 셀 생성
    for (let i = 0; i < 5 * 5; i++) {
        $('#next-block').append('<div class="next-cell"></div>');
    }

    // 랜덤으로 생성될 블럭
    function getRandomBlock() {
        const blocks = [
            { color: 'cyan', shape: [[1, 1, 1, 1]] }, // I 블록
            { color: 'yellow', shape: [[1, 1], [1, 1]] }, // O 블록
            { color: 'purple', shape: [[0, 1, 0], [1, 1, 1]] }, // T 블록
            { color: 'orange', shape: [[1, 0, 0], [1, 1, 1]] }, // L 블록
            { color: 'blue', shape: [[0, 0, 1], [1, 1, 1]] }, // J 블록
            { color: 'green', shape: [[0, 1, 1], [1, 1, 0]] }, // S 블록
            { color: 'red', shape: [[1, 1, 0], [0, 1, 1]] } // Z 블록
        ];
        const block = blocks[Math.floor(Math.random() * blocks.length)];
        return { ...block, x: Math.floor(cols / 2) - 1, y: 0 };
    }

    // 블록 생성
    function drawBlock(block, clear = false) {
        block.shape.forEach((row, y) => {
            row.forEach((cell, x) => {
                if (cell) {
                    const index = (block.y + y) * cols + (block.x + x);
                    $('.cell').eq(index).css('background-color', clear ? '#444' : block.color);
                }
            });
        });
    }

    // 다음 블록 생성
    function drawNextBlock() {
        $('.next-cell').css('background-color', '#444');
        nextBlock.shape.forEach((row, y) => {
            row.forEach((cell, x) => {
                if (cell) {
                    const index = y * 5 + x;
                    $('.next-cell').eq(index).css('background-color', nextBlock.color);
                }
            });
        });
    }

    // 블록 회전하는 함수
    function rotateBlock(block) {
        const newShape = block.shape[0].map((_, index) => block.shape.map(row => row[index]).reverse());
        const originalShape = block.shape;
        block.shape = newShape;
        if (isCollide(block.x, block.y)) block.shape = originalShape;
    }

    // 블록이 충돌했는지(게임 종료 여부) 확인하는 함수
    function isCollide(offsetX, offsetY) {
        return currentBlock.shape.some((row, y) =>
            row.some((cell, x) => cell && (board[offsetY + y] && board[offsetY + y][offsetX + x]) !== 0)
        );
    }

    // 블록 고정 함수
    function fixBlock() {
        currentBlock.shape.forEach((row, y) => {
            row.forEach((cell, x) => {
                if (cell) board[currentBlock.y + y][currentBlock.x + x] = currentBlock.color;
            });
        });
        drawBoard();
    }

    // 전체 보드를  그림
    function drawBoard() {
        board.forEach((row, y) => {
            row.forEach((cell, x) => {
                const index = y * cols + x;
                $('.cell').eq(index).css('background-color', cell || '#444');
            });
        });
    }

    // 한 줄 완성시 점수 추가 및 해당 줄 사라지고 한 줄씩 땡기는 함수
    function clearLines() {
        board.forEach((row, y) => {
            if (row.every(cell => cell !== 0)) {
                board.splice(y, 1);
                board.unshift(Array(cols).fill(0));
                score += 100;
                $('#score').text('Score: ' + score);
            }
        });
        drawBoard();
    }

    // 게임 오버 함수 
    // 타이머 초기화 및 점수창 alert
    function gameOver() {
        clearInterval(timer);
        $('#restart-button').show();
        alert('Game Over! Final Score: ' + score);
    }

    // 블록 하강 함수 만약 충돌시 게임 오버
    function dropBlock() {
        drawBlock(currentBlock, true);
        currentBlock.y++;
        if (isCollide(currentBlock.x, currentBlock.y)) {
            currentBlock.y--;
            fixBlock();
            clearLines();
            currentBlock = nextBlock;
            nextBlock = getRandomBlock();
            drawNextBlock();
            if (isCollide(currentBlock.x, currentBlock.y)) {
                gameOver();
                return;
            }
        }
        drawBlock(currentBlock);
    }

    // 게임시작 함수
    function startGame() {
        $('#start-button').hide();
        $('#restart-button').hide(); // 시작 버튼 비가시화
        score = 0;
        $('#score').text('Score: ' + score);
        for (let y = 0; y < rows; y++) board[y].fill(0);
        currentBlock = getRandomBlock();
        nextBlock = getRandomBlock();
        drawNextBlock();
        timer = setInterval(dropBlock, 500);
    }

    // 블록 이동 함수
    function moveBlock(offsetX, offsetY) {
        drawBlock(currentBlock, true);
        currentBlock.x += offsetX;
        currentBlock.y += offsetY;
        if (isCollide(currentBlock.x, currentBlock.y)) {
            currentBlock.x -= offsetX;
            currentBlock.y -= offsetY;
        }
        drawBlock(currentBlock);
    }

    $(document).keydown(function(e) {
        switch (e.key) {
            case "ArrowLeft":
                moveBlock(-1, 0);
                break;
            case "ArrowRight":
                moveBlock(1, 0);
                break;
            case "ArrowDown":
                moveBlock(0, 1);
                break;
            case "Shift":
                drawBlock(currentBlock, true);
                rotateBlock(currentBlock);
                drawBlock(currentBlock);
                break;
        }
    });

    // 클릭시 게임시작 함수 활성화 
    $('#start-button').click(startGame);
    $('#restart-button').click(startGame);
});
</script>
</body>
</html>
